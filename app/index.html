<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>smallcaps.ai â€” RNS Intelligence</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F8FA;
      --card:#FFFFFF;
      --border:#E5E7EB;
      --primary:#2563EB;
      --text:#111827;
      --muted:#6B7280;

      --pos-text:#15803D;
      --pos-bg:#DCFCE7;

      --neg-text:#B91C1C;
      --neg-bg:#FEE2E2;

      --neu-text:#374151;
      --neu-bg:#F3F4F6;

      --r:4px;
      --topbar-h:56px;
      --maxw:1180px;

      --pad:12px;
      --gap:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding-top: var(--topbar-h);
    }
    a{color:inherit; text-decoration:none}
    button, input, select{font:inherit}

    .container{ max-width:var(--maxw); margin:0 auto; padding:0 16px; }

    /* Header */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      height:var(--topbar-h);
      background:#fff;
      border-bottom:1px solid var(--border);
      z-index:50;
    }
    .topbar-inner{ height:100%; display:flex; align-items:center; gap:16px; }
    .logo{ font-weight:700; letter-spacing:-0.01em; white-space:nowrap; }
    .brand-accent{ color:var(--primary); font-weight:700; }
    .search{ flex:1; display:flex; justify-content:center; }
    .search input{
      width:min(560px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:8px 10px;
      outline:none;
      color:var(--text);
    }
    .search input::placeholder{color:var(--muted)}
    .nav{ display:flex; gap:14px; white-space:nowrap; color:var(--muted); font-weight:600; }
    .nav a{ padding:6px 6px; border-radius:var(--r); }
    .nav a.active{ color:var(--text) }

    @media (max-width: 520px){
      .topbar-inner{ gap:10px; }
      .nav{ display:none; }
      .search{ justify-content:flex-end; }
      .search input{ width:100%; }
    }

    main{ padding-top:24px; padding-bottom:28px; }

    /* Controls */
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:12px 0 10px;
      flex-wrap:wrap;
    }

    .tabs{ display:flex; gap:16px; align-items:flex-end; }
    .tab{
      background:transparent; border:0; padding:8px 0;
      color:var(--muted); font-weight:700; cursor:pointer; position:relative;
    }
    .tab[aria-selected="true"]{ color:var(--text); }
    .tab[aria-selected="true"]::after{
      content:""; position:absolute; left:0; right:0; bottom:-6px;
      height:2px; background:var(--primary);
    }

    .sort{ display:flex; align-items:center; gap:8px; color:var(--muted); font-weight:600; }
    .sort select{
      background:#fff; border:1px solid var(--border); border-radius:var(--r);
      padding:7px 10px; color:var(--text); outline:none;
    }

    /* Filters (slimmer) */
    .filters{
      display:flex;
      gap:8px;
      overflow:auto;
      padding:8px 0 10px;
      scrollbar-width:thin;
      align-items:center;
      flex-wrap:nowrap;
    }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:999px;
      padding:6px 10px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .pill[aria-pressed="true"]{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
    }
    .type-select{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-weight:600;
      flex:0 0 auto;
    }
    .type-select select{
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      color:var(--text);
      outline:none;
      font-weight:700;
      font-size:12px;
    }

    /* Section header */
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:34px 0 12px;
    }
    .hi-title-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      height:26px;
      padding:0 10px;
      border-radius:999px;
      color:var(--primary);
      background:#EFF6FF;
      border:1px solid rgba(37,99,235,.25);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }

    /* Grid */
    .grid{ display:grid; gap:var(--gap); grid-template-columns:1fr; }
    @media (min-width: 760px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1120px){ .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }

    /* Cards (agreed hierarchy) */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:var(--pad);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:150px;
      position:relative;
      cursor:pointer;
    }
    .card:hover{ border-color:#D1D5DB; }
    .card:focus{ outline:2px solid rgba(37,99,235,.18); outline-offset:2px; }

    /* Watchlist star (top-right) */
    .watch{
      position:absolute;
      top:8px;
      right:8px;
      width:22px;
      height:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
      cursor:pointer;
      color:#9CA3AF;
      font-size:14px;
      transition:all .15s ease;
      user-select:none;
    }
    .watch:hover{
      background:#F3F4F6;
      color:#6B7280;
    }
    .watch.active{
      color:#D97706; /* gold when saved */
    }

    /* Row 1: ticker + dots + time */
    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-right:22px; /* space so time doesn't collide with star on small cards */
    }
    .topline-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .ticker{
      font-family:"Roboto Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:600;
      letter-spacing:0.01em;
      font-size:13px;
      color:var(--text);
      flex:0 0 auto;
    }

    /* Materiality dots = intensity (NOT sentiment color) */
    .impact{ display:flex; gap:4px; align-items:center; flex:0 0 auto; }
    .dot{ width:8px; height:8px; border-radius:999px; background:var(--border); }
    .dot.filled{ background:rgba(37,99,235,.25); }
    .dot.filled.m3{ background:rgba(37,99,235,.45); }
    .dot.filled.m4{ background:rgba(37,99,235,.75); }
    .dot.filled.m5{ background:var(--primary); }

    .meta{
      display:flex;
      align-items:center;
      gap:0;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .timestamp{ color:var(--muted); }

    .live-dot{
      width:7px; height:7px; border-radius:999px;
      background:#16A34A; opacity:.45; flex:0 0 auto; margin-right:6px;
      animation: liveSoftPulse 2.4s ease-in-out infinite;
    }
    @keyframes liveSoftPulse{ 0%{opacity:.18} 50%{opacity:.6} 100%{opacity:.18} }
    @media (prefers-reduced-motion: reduce){ .live-dot{ animation:none; } }

    /* Row 2: headline (dominant, not shouty) */
    .headline{
      font-weight:600;
      font-size:13px;
      line-height:1.3;
      color:#0F172A;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      margin-top:2px;
    }

    /* Row 3: key metric (single hard line, medium weight) */
    .keyline{
      margin:0;
      font-size:12.5px;
      line-height:1.35;
      color:#1F2937;
      font-weight:500;
      display:-webkit-box;
      -webkit-line-clamp:1;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* Row 4: top signals (supporting, lighter) */
    .signals{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .sig{
      font-size:12px;
      line-height:1.35;
      color:#4B5563;
      font-weight:400;
      display:-webkit-box;
      -webkit-line-clamp:1;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .sig .g{ color:var(--pos-text); font-weight:800; margin-right:6px; }
    .sig .r{ color:var(--neg-text); font-weight:800; margin-right:6px; }
    .sig .n{ color:var(--muted);    font-weight:800; margin-right:6px; }

    /* Row 5: subtle metadata (sentiment + type) */
    .submeta{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-top:4px;
    }
    .meta-left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      overflow:hidden;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      height:22px;
      padding:0 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      white-space:nowrap;
      border:1px solid transparent;
      flex:0 0 auto;
    }
    .chip.pos{ color:var(--pos-text); background:var(--pos-bg); border-color:rgba(21,128,61,.15); }
    .chip.neg{ color:var(--neg-text); background:var(--neg-bg); border-color:rgba(185,28,28,.15); }
    .chip.neu{ color:var(--neu-text); background:var(--neu-bg); border-color:rgba(55,65,81,.10); }

    .type{
      color:#1D4ED8;
      background:#EFF6FF;
      border:1px solid rgba(37,99,235,.18);
    }

    .company{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .view{
      color:var(--primary);
      font-weight:800;
      font-size:12px;
      flex:0 0 auto;
    }
    .view:hover{ text-decoration:underline; }

    /* High material card accent */
    .card.high{ border-color:#D1D5DB; }
    .card.high::before{
      content:"";
      position:absolute;
      left:-1px; top:-1px; bottom:-1px;
      width:3px;
      background:var(--primary);
      border-top-left-radius:var(--r);
      border-bottom-left-radius:var(--r);
    }

    /* Gating (fade, not blur) */
    .gated{ position:relative; overflow:hidden; border-radius:var(--r); }
    .gated .grid{ opacity:.38; pointer-events:none; user-select:none; }
    .gate-overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:14px;
      background:rgba(246,248,250,.78);
    }
    .gate-panel{
      width:min(440px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .gate-text .title{ font-weight:800; font-size:13px; margin:0 0 2px; color:var(--text); }
    .gate-text .sub{ margin:0; font-size:12px; color:var(--muted); }

    .btn{
      border:1px solid var(--primary);
      background:var(--primary);
      color:#fff;
      border-radius:var(--r);
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }

    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;
    }
  </style>
</head>

<body>
  <header class="topbar" role="banner">
    <div class="container topbar-inner">
      <div class="logo">smallcaps<span class="brand-accent">.ai</span></div>

      <div class="search" role="search">
        <input id="search" type="search" placeholder="Search ticker or companyâ€¦" autocomplete="off" />
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="#" class="active">Feed</a>
        <a href="#">Watchlist</a>
        <a href="#">Account</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="section-title">
      <div class="hi-title-pill">â˜… Material</div>
      <div class="meta"><span class="timestamp" id="hiUpdated">Updated just now</span></div>
    </div>

    <section class="grid" id="highImpactGrid" aria-label="Material announcements"></section>

    <div class="row" style="margin-top:18px;">
      <div class="tabs" role="tablist" aria-label="Feed tabs">
        <button class="tab" role="tab" id="tabToday" aria-selected="true" aria-controls="panelToday">Today</button>
        <button class="tab" role="tab" id="tabAll" aria-selected="false" aria-controls="panelAll">All</button>
      </div>

      <div class="sort">
        <label for="sortSelect" class="sr-only">Sort</label>
        <select id="sortSelect">
          <option value="recent" selected>Most Recent</option>
          <option value="materiality">Highest Materiality</option>
        </select>
      </div>
    </div>

    <div class="filters" aria-label="Filters">
      <button class="pill" data-filter="Negative" aria-pressed="false">Negative</button>
      <button class="pill" data-filter="Positive" aria-pressed="false">Positive</button>
      <button class="pill" data-filter="Materiality>=6" aria-pressed="false">Materiality â‰¥6</button>

      <div class="type-select" aria-label="Type filter">
        <label for="typeSelect" class="sr-only">Type</label>
        <select id="typeSelect">
          <option value="all" selected>All types</option>
          <option value="results">Results</option>
          <option value="trading_update">Trading</option>
          <option value="placing">Placing</option>
          <option value="contract">Contract</option>
          <option value="director_dealing">Director dealing</option>
          <option value="acquisition">M&amp;A</option>
          <option value="regulatory">Regulatory</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>

    <section id="panelToday" role="tabpanel" aria-labelledby="tabToday">
      <div class="grid" id="todayGrid" aria-label="Today feed"></div>
    </section>

    <section id="panelAll" role="tabpanel" aria-labelledby="tabAll" hidden>
      <div class="grid" id="allGrid" aria-label="All feed"></div>
    </section>
  </main>

  <script>
    const state = {
      userPlan: "free",          // "free" | "pro"
      activeFilters: new Set(),
      sort: "recent",
      query: "",
      type: "all"
    };

    // Mock data (your schema; materiality_score is 1â€“10)
    const rns = [
      {
        id:"ANG-1",
        ticker:"ANG",
        company_name:"Angling Direct plc",
        announcement_type:"trading_update",
        sentiment:"positive",
        sentiment_score:4,
        headline:"EBITDA beats upgraded guidance; record revenue Â£103.9m",
        key_metric:"Â£4.8m Adj. EBITDA vs Â£4.35m consensus",
        vs_guidance:"ahead of recently upgraded market expectations", // detail-only
        management_tone:"confident in outlook; ambitions updated at Final Results 12 May 2026", // detail-only
        has_comparatives:true,
        signal_balance:{ positive:4, negative:1, neutral:0 }, // detail-only
        signals:[
          { level:"positive", label:"Adj. EBITDA circa Â£4.8m vs upgraded consensus of Â£4.35m â€” ahead of recently upgraded market expectations" },
          { level:"positive", label:"Revenue +13.8% to Â£103.9m (FY25: Â£91.3m); UK like-for-like store sales +5.8%" },
          { level:"positive", label:"Â£1.1m returned via buyback in FY26; ~Â£1.7m total since Dec 2024 (~6.0% of issued share capital)" },
          { level:"positive", label:"Â£100m medium-term revenue target substantially achieved within two years; new ambitions to be set at Final Results" },
          { level:"negative", label:"Net cash reduced to Â£10.9m (FY25: Â£12.1m), -9.5% year-on-year" }
        ],
        impact:"medium",
        materiality_score:6,
        category:"earnings",
        confidence:"high",
        time: minutesAgoISO(12),
        url:"#",
        watchlisted:false
      },
      {
        id:"MNO-2",
        ticker:"MNO",
        company_name:"Mono Group",
        announcement_type:"placing",
        sentiment:"high_negative",
        sentiment_score:1,
        headline:"Equity placing to strengthen balance sheet",
        key_metric:"Placing at 18% discount; gross proceeds Â£6.0m",
        signals:[
          {level:"negative", label:"Dilution via placing at 18% discount"},
          {level:"negative", label:"Working capital support required"}
        ],
        impact:"high",
        materiality_score:9,
        category:"dilution",
        confidence:"high",
        time: minutesAgoISO(38),
        url:"#",
        watchlisted:true
      },
      {
        id:"QRS-3",
        ticker:"QRS",
        company_name:"Quasar Renewables",
        announcement_type:"contract",
        sentiment:"positive",
        sentiment_score:3,
        headline:"Material contract win with UK utility partner",
        key_metric:"Contract value up to Â£12m over 3 years (conditional)",
        signals:[
          {level:"positive", label:"Multi-year contract adds recurring revenue"},
          {level:"positive", label:"Option to scale footprint"}
        ],
        impact:"high",
        materiality_score:8,
        category:"contract",
        confidence:"medium",
        time: minutesAgoISO(75),
        url:"#",
        watchlisted:false
      },
      {
        id:"RKT-4",
        ticker:"RKT",
        company_name:"Rocket Fintech",
        announcement_type:"results",
        sentiment:"negative",
        sentiment_score:1,
        headline:"Guidance revised lower due to churn in SME segment",
        key_metric:"FY revenue guide down 8â€“10%; cost actions announced",
        signals:[
          {level:"negative", label:"FY revenue guidance cut 8â€“10%"},
          {level:"negative", label:"Higher churn; slower pipeline conversion"}
        ],
        impact:"high",
        materiality_score:8,
        category:"earnings",
        confidence:"high",
        time: minutesAgoISO(22),
        url:"#",
        watchlisted:false
      },
      {
        id:"TUV-5",
        ticker:"TUV",
        company_name:"TUV Tech",
        announcement_type:"director_dealing",
        sentiment:"neutral",
        sentiment_score:2,
        headline:"Director dealing: small on-market purchase",
        key_metric:"Director bought 25,000 shares at 42.0p",
        signals:[
          {level:"positive", label:"Director on-market purchase"}
        ],
        impact:"medium",
        materiality_score:5,
        category:"insider_activity",
        confidence:"high",
        time: hoursAgoISO(2),
        url:"#",
        watchlisted:false
      },
      {
        id:"ZED-6",
        ticker:"ZED",
        company_name:"Zed Systems",
        announcement_type:"regulatory",
        sentiment:"neutral",
        sentiment_score:2,
        headline:"Notice of AGM and proxy information",
        key_metric:"AGM on 19 Mar 2026",
        signals:[
          {level:"neutral", label:"Administrative AGM notice"}
        ],
        impact:"low",
        materiality_score:2,
        category:"general",
        confidence:"high",
        time: daysAgoISO(2),
        url:"#",
        watchlisted:false
      }
    ];

    function minutesAgoISO(m){ return new Date(Date.now() - m*60*1000).toISOString(); }
    function hoursAgoISO(h){ return new Date(Date.now() - h*60*60*1000).toISOString(); }
    function daysAgoISO(d){ return new Date(Date.now() - d*24*60*60*1000).toISOString(); }

    function fmtRelative(iso){
      const t = new Date(iso).getTime();
      const now = Date.now();
      const diffMin = Math.floor((now - t) / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return `${diffMin}m ago`;
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return `${diffHr}h ago`;
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { day:"2-digit", month:"short" });
    }

    function isWithinMinutes(iso, mins){
      const t = new Date(iso).getTime();
      return (Date.now() - t) <= mins * 60 * 1000;
    }

    function esc(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Sentiment (chip only; direction)
    function groupSentiment(s){
      if (s === "high_positive" || s === "positive") return "Positive";
      if (s === "high_negative" || s === "negative") return "Negative";
      return "Neutral";
    }
    function sentimentClass(s){
      const g = groupSentiment(s);
      if (g === "Positive") return "pos";
      if (g === "Negative") return "neg";
      return "neu";
    }
    function sentimentLabel(s){
      if (s === "high_positive") return "Positive â–²";
      if (s === "high_negative") return "Negative â–¼";
      if (s === "positive") return "Positive";
      if (s === "negative") return "Negative";
      return "Neutral";
    }

    function typeLabel(t){
      const map = {
        results:"Results",
        trading_update:"Trading",
        placing:"Placing",
        director_dealing:"Director dealing",
        contract:"Contract",
        acquisition:"M&A",
        regulatory:"Regulatory",
        other:"Other"
      };
      return map[t] || "Other";
    }

    // 1â€“10 materiality -> 1â€“5 dots (agreed remap)
    function materialityToDots(ms){
      const n = Math.max(1, Math.min(10, Number(ms || 1)));
      if (n <= 2) return 1;
      if (n <= 4) return 2;
      if (n <= 6) return 3;
      if (n <= 8) return 4;
      return 5;
    }

    function dots(ms){
      const n = materialityToDots(ms);
      let out = "";
      for (let i=1;i<=5;i++){
        const filled = i<=n;
        const ramp = n >= 5 ? "m5" : n === 4 ? "m4" : n === 3 ? "m3" : "";
        out += `<span class="dot ${filled ? `filled ${ramp}` : ""}"></span>`;
      }
      return out;
    }

    // Signals: show 2 max, but always include a negative if one exists (trust boost)
    function topSignals(item){
      const arr = Array.isArray(item.signals) ? item.signals : [];
      const neg = arr.find(s => s.level === "negative");
      const pos = arr.find(s => s.level === "positive");
      const neu = arr.find(s => s.level === "neutral");

      const picked = [];
      if (neg) picked.push(neg);
      // second pick: prefer strongest positive, else neutral
      if (picked.length < 2){
        if (pos && pos !== neg) picked.push(pos);
        else if (neu && neu !== neg) picked.push(neu);
      }

      // fallback: if no neg exists, take up to 2 by rank (pos, neu)
      if (!neg){
        const rank = (lvl) => lvl === "positive" ? 1 : (lvl === "neutral" ? 2 : 3);
        return [...arr].sort((a,b)=>rank(a.level)-rank(b.level)).slice(0,2);
      }

      return picked;
    }

    function matchFilters(item){
      const f = state.activeFilters;

      // Sentiment filters (Positive/Negative only)
      const sentimentFilters = ["Negative","Positive"].filter(x => f.has(x));
      if (sentimentFilters.length){
        const g = groupSentiment(item.sentiment);
        if (!sentimentFilters.includes(g)) return false;
      }

      // Materiality filter (1â€“10 scale)
      if (f.has("Materiality>=6") && Number(item.materiality_score||0) < 6) return false;

      // Type dropdown
      if (state.type !== "all" && item.announcement_type !== state.type) return false;

      return true;
    }

    function matchQuery(item){
      const q = state.query.trim().toLowerCase();
      if (!q) return true;
      return (
        String(item.ticker||"").toLowerCase().includes(q) ||
        String(item.company_name||"").toLowerCase().includes(q) ||
        String(item.headline||"").toLowerCase().includes(q)
      );
    }

    function sortItems(items){
      if (state.sort === "materiality"){
        return [...items].sort((a,b) => (Number(b.materiality_score||0) - Number(a.materiality_score||0)) || (new Date(b.time)-new Date(a.time)));
      }
      return [...items].sort((a,b) => new Date(b.time) - new Date(a.time));
    }

    function cardHTML(item, {high=false}={}){
      const live = isWithinMinutes(item.time, 15) ? `<span class="live-dot" aria-hidden="true"></span>` : "";
      const sClass = sentimentClass(item.sentiment);

      const sigs = topSignals(item);
      const sigHTML = sigs.length ? `
        <ul class="signals" aria-label="Top signals">
          ${sigs.map(s=>{
            const glyph = s.level==="positive" ? `<span class="g">+</span>` :
                          s.level==="negative" ? `<span class="r">âˆ’</span>` :
                          `<span class="n">~</span>`;
            return `<li class="sig">${glyph}${esc(s.label)}</li>`;
          }).join("")}
        </ul>
      ` : "";

      return `
        <article class="card ${high ? "high":""}" tabindex="0" data-url="${esc(item.url)}" data-id="${esc(item.id)}">
          <span class="watch ${item.watchlisted ? "active" : ""}" role="button" aria-label="Toggle watchlist" data-watch="${esc(item.id)}">â˜…</span>

          <div class="topline">
            <div class="topline-left">
              <span class="ticker">${esc(item.ticker)}</span>
              <div class="impact" aria-label="Materiality ${esc(item.materiality_score)}/10">${dots(item.materiality_score)}</div>
            </div>
            <div class="meta">${live}<span class="timestamp" data-time="${esc(item.time)}">${fmtRelative(item.time)}</span></div>
          </div>

          <div class="headline">${esc(item.headline)}</div>

          ${item.key_metric ? `<p class="keyline">ðŸ“Œ ${esc(item.key_metric)}</p>` : ``}

          ${sigHTML}

          <div class="submeta">
            <div class="meta-left">
              <span class="chip ${sClass}">${esc(sentimentLabel(item.sentiment))}</span>
              <span class="chip type">${esc(typeLabel(item.announcement_type))}</span>
              <span class="company">${esc(item.company_name)}</span>
            </div>
            <a class="view" href="${esc(item.url)}" target="_blank" rel="noopener">View RNS â†—</a>
          </div>
        </article>
      `;
    }

    function bindCardClicks(){
      document.querySelectorAll(".card").forEach(card => {
        const open = () => {
          const url = card.getAttribute("data-url");
          if (!url || url === "#") return;
          window.open(url, "_blank", "noopener");
        };
        card.onclick = (e) => {
          if (e.target.closest("a,button,select,.watch")) return;
          open();
        };
        card.onkeydown = (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            open();
          }
        };
      });
    }

    function bindWatchlist(){
      document.querySelectorAll(".watch").forEach(star => {
        star.onclick = (e) => {
          e.stopPropagation();
          const id = star.getAttribute("data-watch");
          star.classList.toggle("active");

          // update in-memory state (MVP); replace with API later
          const item = rns.find(x => x.id === id);
          if (item) item.watchlisted = !item.watchlisted;

          console.log("Toggle watchlist:", id, "->", item?.watchlisted);
        };
      });
    }

    function render(){
      const items = sortItems(rns).filter(matchQuery).filter(matchFilters);

      // Material section = materiality >= 8 (1â€“10 scale)
      const hi = sortItems(items.filter(x => Number(x.materiality_score||0) >= 8)).slice(0,5);
      document.getElementById("highImpactGrid").innerHTML = hi.map(x => cardHTML(x,{high:true})).join("");

      document.getElementById("todayGrid").innerHTML = items.map(x => cardHTML(x)).join("");

      const allGrid = document.getElementById("allGrid");
      if (state.userPlan === "free"){
        const first = items.slice(0,3);
        const rest  = items.slice(3);
        allGrid.innerHTML = first.map(x => cardHTML(x)).join("") + (rest.length ? `
          <div class="gated" style="grid-column:1 / -1;">
            <div class="grid">${rest.map(x => cardHTML(x)).join("")}</div>
            <div class="gate-overlay">
              <div class="gate-panel" role="region" aria-label="Upgrade gate">
                <div class="gate-text">
                  <p class="title">Unlock full-day feed</p>
                  <p class="sub">See all announcements from today.</p>
                </div>
                <button class="btn" type="button" id="upgradeBtn">Upgrade</button>
              </div>
            </div>
          </div>
        ` : "");
      } else {
        allGrid.innerHTML = items.map(x => cardHTML(x)).join("");
      }

      // Updated label
      const hiUpdated = document.getElementById("hiUpdated");
      if (hiUpdated){
        if (hi.length){
          const newest = hi.reduce((a,b) => new Date(a.time) > new Date(b.time) ? a : b);
          hiUpdated.textContent = `Updated ${fmtRelative(newest.time)}`;
        } else {
          hiUpdated.textContent = "No material items";
        }
      }

      // Upgrade
      const btn = document.getElementById("upgradeBtn");
      if (btn) btn.onclick = () => alert("Route to /account/upgrade (no modal).");

      bindCardClicks();
      bindWatchlist();
    }

    // Tabs
    const tabToday = document.getElementById("tabToday");
    const tabAll = document.getElementById("tabAll");
    const panelToday = document.getElementById("panelToday");
    const panelAll = document.getElementById("panelAll");
    function setTab(which){
      const isToday = which === "today";
      tabToday.setAttribute("aria-selected", String(isToday));
      tabAll.setAttribute("aria-selected", String(!isToday));
      panelToday.hidden = !isToday;
      panelAll.hidden = isToday;
    }
    tabToday.addEventListener("click", () => setTab("today"));
    tabAll.addEventListener("click", () => setTab("all"));

    // Filters
    document.querySelectorAll(".pill").forEach(btn => {
      btn.addEventListener("click", () => {
        const f = btn.getAttribute("data-filter");
        if (state.activeFilters.has(f)) state.activeFilters.delete(f);
        else state.activeFilters.add(f);
        btn.setAttribute("aria-pressed", String(state.activeFilters.has(f)));
        render();
      });
    });

    // Type dropdown
    document.getElementById("typeSelect").addEventListener("change", (e) => {
      state.type = e.target.value;
      render();
    });

    // Sort
    document.getElementById("sortSelect").addEventListener("change", (e) => {
      state.sort = e.target.value;
      render();
    });

    // Search
    const search = document.getElementById("search");
    let t = null;
    search.addEventListener("input", (e) => {
      clearTimeout(t);
      t = setTimeout(() => { state.query = e.target.value || ""; render(); }, 120);
    });

    // Initial render
    render();

    // Refresh timestamps only
    setInterval(() => {
      document.querySelectorAll("[data-time]").forEach(el => {
        el.textContent = fmtRelative(el.getAttribute("data-time"));
      });
    }, 30_000);
  </script>
</body>
</html>
