<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>smallcaps.ai â€” RNS Intelligence</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F6F8FA;
      --card:#FFFFFF;
      --border:#E5E7EB;
      --primary:#2563EB;
      --text:#111827;
      --muted:#6B7280;
      --pill-bg:#F3F4F6;
      --pos-text:#15803D;
      --pos-bg:#DCFCE7;
      --neg-text:#B91C1C;
      --neg-bg:#FEE2E2;
      --neu-text:#374151;
      --neu-bg:#F3F4F6;
      --r:4px;
      --topbar-h:56px;
      --maxw:1180px;
      --pad-2:12px;
      --gap:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
   body{
  margin:0;
  font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding-top: var(--topbar-h); /* âœ… pushes ALL content below fixed header */
} 
    a{color:inherit;text-decoration:none}
    button,input,select{font:inherit}

    .container{max-width:var(--maxw);margin:0 auto;padding:0 16px}

    /* Topbar */
    .topbar{
      position:fixed;top:0;left:0;right:0;
      height:var(--topbar-h);
      background:#fff;
      border-bottom:1px solid var(--border);
      z-index:50;
    }
    .topbar-inner{
      height:100%;display:flex;align-items:center;gap:16px;
    }
    .logo{font-weight:700;letter-spacing:-0.02em;font-size:15px;white-space:nowrap}
    .logo span{color:var(--primary)}

    /* Live badge */
    .live-badge{
      display:flex;align-items:center;gap:5px;
      font-size:11px;font-weight:700;color:var(--muted);
      white-space:nowrap;
    }
    .live-dot{
      width:7px;height:7px;border-radius:999px;background:#22C55E;
      animation:pulse 2s infinite;
    }
    @keyframes pulse{
      0%,100%{opacity:1}50%{opacity:0.35}
    }

    .search{flex:1;display:flex;justify-content:center}
    .search input{
      width:min(520px,100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:8px 10px;
      outline:none;
      color:var(--text);
      font-size:13px;
    }
    .search input:focus{border-color:var(--primary)}
    .search input::placeholder{color:var(--muted)}

    .nav{display:flex;gap:14px;white-space:nowrap;color:var(--muted);font-weight:500;font-size:13px}
    .nav a{padding:6px;border-radius:var(--r)}
    .nav a.active{color:var(--text)}
    .nav a:hover{color:var(--text)}

    /* Main */
main{
  padding-top: 24px;  /* just extra space under header */
  padding-bottom: 28px;
}

    /* Row */
    .row{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin:12px 0 10px;flex-wrap:wrap;
    }

    /* Tabs */
    .tabs{display:flex;gap:16px;align-items:flex-end}
    .tab{
      background:transparent;border:0;
      padding:8px 0;color:var(--muted);font-weight:600;font-size:13px;
      cursor:pointer;position:relative;
    }
    .tab[aria-selected="true"]{color:var(--text)}
    .tab[aria-selected="true"]::after{
      content:"";position:absolute;left:0;right:0;bottom:-6px;
      height:2px;background:var(--primary);
    }

    /* Sort */
    .sort{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:500;font-size:13px}
    .sort select{
      background:#fff;border:1px solid var(--border);
      border-radius:var(--r);padding:7px 10px;
      color:var(--text);outline:none;font-size:13px;cursor:pointer;
    }

    /* Filters */
    .filters{
      display:flex;gap:8px;overflow:auto;
      padding:8px 0 10px;scrollbar-width:thin;
      -webkit-overflow-scrolling:touch;
    }
    .pill{
      border:1px solid var(--border);background:var(--pill-bg);
      color:var(--text);border-radius:999px;
      padding:6px 12px;font-weight:600;font-size:12px;
      cursor:pointer;white-space:nowrap;transition:all .15s;
    }
    .pill[aria-pressed="true"]{
      background:var(--primary);border-color:var(--primary);color:#fff;
    }

    /* Section title */
    .section-title{
      display:flex;align-items:center;justify-content:space-between;
      margin:14px 0 8px;
    }
    .section-title .label{
      font-size:11px;color:var(--muted);font-weight:800;
      letter-spacing:0.06em;text-transform:uppercase;
    }

    /* Grid */
    .grid{display:grid;gap:var(--gap);grid-template-columns:1fr}
    @media(min-width:760px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1060px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    /* Skeleton */
    .skeleton{
      background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);
      background-size:200% 100%;
      animation:shimmer 1.3s infinite;
      border-radius:var(--r);height:152px;
      border:1px solid var(--border);
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* Empty state */
    .empty{
      grid-column:1/-1;
      text-align:center;padding:40px 16px;
      color:var(--muted);font-size:13px;
    }

    /* Error state */
    .error-bar{
      background:#FEF2F2;border:1px solid #FECACA;
      border-radius:var(--r);padding:10px 14px;
      font-size:12px;color:#B91C1C;font-weight:600;
      margin-bottom:10px;display:none;
    }

    /* Cards */
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--r);padding:var(--pad-2);
      display:flex;flex-direction:column;gap:8px;
      min-height:152px;position:relative;
      transition:box-shadow .15s;
    }
    .card:hover{box-shadow:0 2px 8px rgba(0,0,0,.07)}

/* New announcement indicator (corner) */
    .card{
  position: relative;   /* anchor for corner dot */
}
    
.card-newdot{
  position:absolute;
  top:10px;
  right:10px;
  width:8px;
  height:8px;
  border-radius:999px;
  background:#16A34A; /* green */
  display:none;
}

/* Only show when new */
.card[data-new="true"] .card-newdot{
  display:block;
}

    .card-top{
      display:flex;align-items:flex-start;
      justify-content:space-between;gap:10px;
    }
    .left{min-width:0;flex:1}

    .ticker-row{
      display:flex;align-items:center;
      gap:8px;flex-wrap:wrap;
    }
    .ticker{
      font-family:"Roboto Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-weight:600;letter-spacing:0.01em;font-size:13px;color:var(--text);
    }

    .impact{display:flex;gap:3px;align-items:center}
    .dot{width:7px;height:7px;border-radius:999px;background:#E5E7EB}
    .dot.filled{background:var(--primary)}

    .sentiment{
      font-weight:700;font-size:11px;
      padding:3px 8px;border-radius:999px;
      border:1px solid transparent;white-space:nowrap;
    }
    .sentiment.pos{color:var(--pos-text);background:var(--pos-bg);border-color:rgba(21,128,61,.15)}
    .sentiment.neg{color:var(--neg-text);background:var(--neg-bg);border-color:rgba(185,28,28,.15)}
    .sentiment.neu{color:var(--neu-text);background:var(--neu-bg);border-color:rgba(55,65,81,.10)}

    .cat-tag{
      font-size:10px;font-weight:700;
      padding:2px 6px;border-radius:999px;
      background:#EFF6FF;color:#1D4ED8;
      border:1px solid #BFDBFE;
      white-space:nowrap;
    }

    .headline{
      margin-top:5px;font-weight:600;font-size:13px;
      line-height:1.3;color:var(--text);
      display:-webkit-box;-webkit-line-clamp:2;
      -webkit-box-orient:vertical;overflow:hidden;
    }

    .meta{
      display:flex;align-items:center;gap:8px;
      color:var(--muted);font-size:11px;white-space:nowrap;
    }

    .summary{
      margin:0;color:var(--text);font-size:12.5px;
      line-height:1.45;
      display:-webkit-box;-webkit-line-clamp:3;
      -webkit-box-orient:vertical;overflow:hidden;
    }
    .context{
      margin:0;color:var(--muted);font-size:12px;
      line-height:1.35;font-weight:500;
      display:-webkit-box;-webkit-line-clamp:1;
      -webkit-box-orient:vertical;overflow:hidden;
    }

    .card-footer{
      margin-top:auto;display:flex;
      justify-content:space-between;align-items:center;
      padding-top:4px;border-top:1px solid var(--border);
    }
    .view{color:var(--primary);font-weight:700;font-size:12px}
    .view:hover{text-decoration:underline}

    /* High impact */
    .card.high{border-color:#D1D5DB}
    .card.high::before{
      content:"";position:absolute;
      left:-1px;top:-1px;bottom:-1px;
      width:3px;background:var(--primary);
      border-top-left-radius:var(--r);
      border-bottom-left-radius:var(--r);
    }
    .hi-label{
      font-size:10px;font-weight:800;color:var(--primary);
      letter-spacing:0.06em;text-transform:uppercase;
      margin-bottom:2px;
    }

    /* Gating */
    .gated{position:relative;overflow:hidden}
    .gated .card{filter:blur(5px);pointer-events:none;user-select:none}
    .gate-overlay{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      background:rgba(246,248,250,.75);
    }
    .gate-panel{
      width:min(440px,100%);background:#fff;
      border:1px solid var(--border);border-radius:var(--r);
      padding:14px;display:flex;align-items:center;
      justify-content:space-between;gap:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
    }
    .gate-text .title{font-weight:700;font-size:13px;margin:0 0 3px;color:var(--text)}
    .gate-text .sub{margin:0;font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid var(--primary);background:var(--primary);
      color:#fff;border-radius:var(--r);
      padding:9px 14px;font-weight:800;font-size:12px;
      cursor:pointer;white-space:nowrap;
    }
    .btn:hover{background:#1D4ED8}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  </style>
</head>

<body>
  <header class="topbar" role="banner">
    <div class="container topbar-inner">
      <div class="logo">smallcaps<span>.ai</span></div>

      <div class="live-badge">
        <span class="live-dot"></span> Live
      </div>

      <div class="search" role="search">
        <input id="search" type="search" placeholder="Search ticker or companyâ€¦" autocomplete="off" />
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="#" class="active">Feed</a>
        <a href="#">Watchlist</a>
        <a href="#">Account</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div id="errorBar" class="error-bar" role="alert">
      Could not load feed â€” retrying in 60 seconds.
    </div>

    <!-- HIGH IMPACT -->
    <div class="section-title">
      <div class="label">High Impact</div>
      <div class="meta"><span id="hiUpdated">Updated just now</span></div>
    </div>
    <section class="grid" id="highImpactGrid" aria-label="High Impact announcements"></section>

    <!-- TABS + SORT -->
    <div class="row" style="margin-top:20px">
      <div class="tabs" role="tablist" aria-label="Feed tabs">
        <button class="tab" role="tab" id="tabToday" aria-selected="true" aria-controls="panelToday">Today</button>
        <button class="tab" role="tab" id="tabAll" aria-selected="false" aria-controls="panelAll">All Today</button>
      </div>
      <div class="sort">
        <label for="sortSelect" class="sr-only">Sort</label>
        <select id="sortSelect">
          <option value="recent" selected>Most Recent</option>
          <option value="impact">Highest Impact</option>
        </select>
      </div>
    </div>

    <!-- FILTER PILLS -->
    <div class="filters" aria-label="Filters">
      <button class="pill" data-filter="Negative" aria-pressed="false">Negative</button>
      <button class="pill" data-filter="Positive" aria-pressed="false">Positive</button>
      <button class="pill" data-filter="Neutral" aria-pressed="false">Neutral</button>
      <button class="pill" data-filter="Impact>=3" aria-pressed="false">Impact â‰¥3</button>
      <button class="pill" data-filter="Results" aria-pressed="false">Results</button>
      <button class="pill" data-filter="Fundraise" aria-pressed="false">Fundraise</button>
      <button class="pill" data-filter="Contract" aria-pressed="false">Contract</button>
    </div>

    <!-- FEED PANELS -->
    <section id="panelToday" role="tabpanel" aria-labelledby="tabToday">
      <div class="grid" id="todayGrid"></div>
    </section>

    <section id="panelAll" role="tabpanel" aria-labelledby="tabAll" hidden>
      <div id="allWrapper">
        <div class="grid" id="allGrid"></div>
      </div>
    </section>
  </main>

  <script>
    // â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // To connect live data from Airtable, replace these values:
    // const AIRTABLE_BASE  = "appXXXXXXXXXXXX";
    // const AIRTABLE_TABLE = "announcements";
    // const AIRTABLE_TOKEN = "patXXXXXXXXXXXX";
    // Then call loadFromAirtable() instead of loadMock()
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const state = {
      userPlan: "free",       // "free" | "pro"  â€” change to "pro" to test full feed
      activeTab: "today",
      activeFilters: new Set(),
      sort: "recent",
      query: "",
      viewed: new Set(JSON.parse(localStorage.getItem("sc_viewed") || "[]")),
    };

    // â”€â”€â”€ MOCK DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Replace this array with your Airtable fetch when ready
    let rns = [
      { id:"1",  ticker:"ABC",  company:"Alpha Beta plc",      impact:5, sentiment:"Positive", headline:"Trading update: revenue ahead; FY guidance reiterated",          summary:"Management notes strong demand across core product lines. FY revenue expected to be ahead of market expectations while margins remain stable.",                    context:"FY26 revenue guidance reaffirmed; net cash position maintained.", category:"Results",   time:minsAgo(12), url:"#" },
      { id:"2",  ticker:"MNO",  company:"Mono Group",           impact:4, sentiment:"Negative", headline:"Equity placing to strengthen balance sheet",                     summary:"Company announces an equity raise to support near-term working capital and accelerate delivery timelines. Dilution expected; proceeds earmarked for operations.",  context:"Placing at 18% discount; gross proceeds Â£6.0m.",                  category:"Fundraise",  time:minsAgo(38), url:"#" },
      { id:"3",  ticker:"QRS",  company:"Quasar Renewables",    impact:4, sentiment:"Positive", headline:"Material contract win with UK utility partner",                  summary:"New multi-year agreement expands service footprint and adds recurring revenue profile. Initial phase begins immediately with option to scale.",                     context:"Contract value up to Â£12m over 3 years (conditional).",           category:"Contract",   time:minsAgo(75), url:"#" },
      { id:"4",  ticker:"TUV",  company:"TUV Tech",             impact:3, sentiment:"Neutral",  headline:"Director dealing: small on-market purchase",                     summary:"Non-executive director acquires shares on-market. No change to strategy or outlook disclosed.",                                                                  context:"Purchase: 25,000 shares at 42.0p.",                               category:"",          time:minsAgo(140),url:"#" },
      { id:"5",  ticker:"HJK",  company:"HJK Mining",           impact:2, sentiment:"Negative", headline:"Operational update: short-term disruption at site",              summary:"Temporary interruption impacts near-term output. Remediation underway; company expects to resume normal operations shortly.",                                      context:"FY output range unchanged (subject to recovery timeline).",       category:"",          time:hrsAgo(3),   url:"#" },
      { id:"6",  ticker:"LMP",  company:"Limpet Bio",           impact:3, sentiment:"Positive", headline:"Regulatory milestone achieved for lead program",                 summary:"Regulator accepts filing; next review step scheduled. Company anticipates additional data release in coming weeks.",                                              context:"Submission accepted; timeline dependent on review.",              category:"",          time:hrsAgo(5),   url:"#" },
      { id:"7",  ticker:"ZED",  company:"Zed Systems",          impact:1, sentiment:"Neutral",  headline:"Notice of AGM and proxy information",                            summary:"Administrative update including resolutions and voting procedures for the upcoming AGM.",                                                                        context:"AGM on 19 Mar 2026.",                                             category:"",          time:daysAgo(2),  url:"#" },
      { id:"8",  ticker:"RKT",  company:"Rocket Fintech",       impact:4, sentiment:"Negative", headline:"Guidance revised lower due to churn in SME segment",             summary:"Management notes higher churn and slower pipeline conversion. Cost actions announced; focus shifts to retention and unit economics.",                           context:"FY revenue guide down 8â€“10%; opex reduction plan initiated.",     category:"Results",   time:minsAgo(22), url:"#" },
      { id:"9",  ticker:"NIM",  company:"Nimbus AI",            impact:3, sentiment:"Positive", headline:"Partnership signed; distribution expanded into EU",              summary:"New partner provides channel access and onboarding support. Near-term revenue impact expected to be modest; strategic optionality improves.",                   context:"Initial term 24 months; revenue share disclosed.",                category:"",          time:minsAgo(9),  url:"#" },
    ];

    // â”€â”€â”€ TIME HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function minsAgo(m){ return new Date(Date.now()-m*60000).toISOString() }
    function hrsAgo(h){  return new Date(Date.now()-h*3600000).toISOString() }
    function daysAgo(d){ return new Date(Date.now()-d*86400000).toISOString() }

    function fmtRel(iso){
      const diff = Math.floor((Date.now()-new Date(iso).getTime())/60000);
      if(diff<1)  return "just now";
      if(diff<60) return diff+"m ago";
      const h = Math.floor(diff/60);
      if(h<24)    return h+"h ago";
      return new Date(iso).toLocaleDateString(undefined,{day:"2-digit",month:"short"});
    }

    // â”€â”€â”€ AIRTABLE LOADER (ready to activate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadFromAirtable(){
      // Uncomment and fill in when you have your Airtable details:
      /*
      const url = `https://api.airtable.com/v0/${AIRTABLE_BASE}/${AIRTABLE_TABLE}` +
                  `?sort[0][field]=time&sort[0][direction]=desc&maxRecords=60`;
      const res = await fetch(url,{headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`}});
      if(!res.ok) throw new Error("Airtable fetch failed");
      const data = await res.json();
      return data.records.map(r=>({
        id:        r.id,
        ticker:    r.fields.ticker   || "",
        company:   r.fields.company  || "",
        impact:    r.fields.impact   || 1,
        sentiment: r.fields.sentiment|| "Neutral",
        headline:  r.fields.headline || "",
        summary:   r.fields.summary  || "",
        context:   r.fields.context  || "",
        category:  r.fields.category || "",
        time:      r.fields.time     || new Date().toISOString(),
        url:       r.fields.url      || "#",
      }));
      */
      return rns; // returns mock data until Airtable is wired
    }

    // â”€â”€â”€ FILTER / SORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function matchFilters(item){
      const f = state.activeFilters;
      if(f.has("Negative")  && item.sentiment!=="Negative")  return false;
      if(f.has("Positive")  && item.sentiment!=="Positive")  return false;
      if(f.has("Neutral")   && item.sentiment!=="Neutral")   return false;
      if(f.has("Impact>=3") && item.impact<3)                return false;
      if(f.has("Results")   && item.category!=="Results")    return false;
      if(f.has("Fundraise") && item.category!=="Fundraise")  return false;
      if(f.has("Contract")  && item.category!=="Contract")   return false;
      return true;
    }
    function matchQuery(item){
      const q = state.query.trim().toLowerCase();
      if(!q) return true;
      return item.ticker.toLowerCase().includes(q)||
             item.company.toLowerCase().includes(q)||
             item.headline.toLowerCase().includes(q);
    }
    function sorted(arr){
      if(state.sort==="impact")
        return [...arr].sort((a,b)=>(b.impact-a.impact)||(new Date(b.time)-new Date(a.time)));
      return [...arr].sort((a,b)=>new Date(b.time)-new Date(a.time));
    }

    // â”€â”€â”€ HTML BUILDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function dots(n){
      let s="";
      for(let i=1;i<=5;i++) s+=`<span class="dot ${i<=n?"filled":""}"></span>`;
      return s;
    }
    function sentCls(s){ return s==="Positive"?"pos":s==="Negative"?"neg":"neu" }
    function esc(s){
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;")
                      .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    function cardHTML(item,{high=false}={}){
      const isNew = !state.viewed.has(item.id);
      const catTag = item.category
        ? `<span class="cat-tag">${esc(item.category)}</span>` : "";
      return `
<article class="card ${high?"high":""}" data-id="${item.id}" data-new="${isNew}">
  <span class="card-newdot" title="New"></span>
  ${high?`<div class="hi-label">â˜… High Impact</div>`:""}
        <div class="card-top">
          <div class="left">
            <div class="ticker-row">
              <span class="ticker">${esc(item.ticker)}</span>
              <div class="impact" aria-label="Impact ${item.impact}/5">${dots(item.impact)}</div>
              <span class="sentiment ${sentCls(item.sentiment)}">${esc(item.sentiment)}</span>
              ${catTag}
            </div>
            <div class="headline">${esc(item.headline)}</div>
          </div>
          <div class="meta"><span data-time="${item.time}">${fmtRel(item.time)}</span></div>
        </div>
        <p class="summary">${esc(item.summary)}</p>
        ${item.context?`<p class="context">ðŸ“Œ ${esc(item.context)}</p>`:""}
        <div class="card-footer">
          <a class="view" href="${item.url}" data-action="view" target="_blank" rel="noopener">View RNS â†—</a>
          <span class="meta">${esc(item.company)}</span>
        </div>
      </article>`;
    }

    function skeletons(n=3){
      return Array(n).fill(`<div class="skeleton"></div>`).join("");
    }

    function emptyState(){
      return `<div class="empty">No announcements match your filters.</div>`;
    }

    // â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render(){
      const all   = sorted(rns).filter(matchQuery).filter(matchFilters);
      const hi    = all.filter(x=>x.impact>=4).slice(0,5);

      // High impact section
      document.getElementById("highImpactGrid").innerHTML =
        hi.length ? hi.map(i=>cardHTML(i,{high:true})).join("") : emptyState();

      // Today panel
      document.getElementById("todayGrid").innerHTML =
        all.length ? all.map(i=>cardHTML(i)).join("") : emptyState();

      // All Today panel (gated for free users)
      const allGrid = document.getElementById("allGrid");
      if(state.userPlan==="free"){
        const first = all.slice(0,3);
        const rest  = all.slice(3);
        allGrid.innerHTML =
          first.map(i=>cardHTML(i)).join("") +
          (rest.length
            ? `<div class="gated" id="gateBlock" style="grid-column:1/-1;border-radius:var(--r)">
                <div class="grid">${rest.map(i=>cardHTML(i)).join("")}</div>
                <div class="gate-overlay">
                  <div class="gate-panel" role="region" aria-label="Upgrade gate">
                    <div class="gate-text">
                      <p class="title">Unlock the full-day feed</p>
                      <p class="sub">See every RNS announcement from today, unfiltered.</p>
                    </div>
                    <button class="btn" id="upgradeBtn">Upgrade â†’</button>
                  </div>
                </div>
              </div>`
            : "");
      } else {
        allGrid.innerHTML = all.length ? all.map(i=>cardHTML(i)).join("") : emptyState();
      }

      // Refresh timestamps
      document.querySelectorAll("[data-time]").forEach(el=>{
        el.textContent = fmtRel(el.getAttribute("data-time"));
      });

      bindCardEvents();
      const ub = document.getElementById("upgradeBtn");
      if(ub) ub.onclick = ()=> alert("Navigate to /account/upgrade here.");
    }

    function bindCardEvents(){
      document.querySelectorAll('.card a[data-action="view"]').forEach(a=>{
        a.onclick = e=>{
          const card = e.target.closest(".card");
          if(!card) return;
          const id = card.getAttribute("data-id");
          state.viewed.add(id);
          localStorage.setItem("sc_viewed",JSON.stringify([...state.viewed]));
          card.setAttribute("data-new","false");
        };
      });
    }

    // â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setTab(which){
      state.activeTab = which;
      const isToday = which==="today";
      document.getElementById("tabToday").setAttribute("aria-selected",String(isToday));
      document.getElementById("tabAll").setAttribute("aria-selected",String(!isToday));
      document.getElementById("panelToday").hidden = !isToday;
      document.getElementById("panelAll").hidden   = isToday;
    }
    document.getElementById("tabToday").addEventListener("click",()=>setTab("today"));
    document.getElementById("tabAll").addEventListener("click",()=>setTab("all"));

    // â”€â”€â”€ PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll(".pill").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const f = btn.getAttribute("data-filter");
        if(state.activeFilters.has(f)) state.activeFilters.delete(f);
        else state.activeFilters.add(f);
        btn.setAttribute("aria-pressed",String(state.activeFilters.has(f)));
        render();
      });
    });

    // â”€â”€â”€ SORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("sortSelect").addEventListener("change",e=>{
      state.sort = e.target.value;
      render();
    });

    // â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let searchTimer = null;
    document.getElementById("search").addEventListener("input",e=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{ state.query=e.target.value||""; render(); }, 120);
    });

    // â”€â”€â”€ INIT + AUTO-REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Show skeletons immediately
    document.getElementById("highImpactGrid").innerHTML = skeletons(3);
    document.getElementById("todayGrid").innerHTML      = skeletons(3);

    // Load data
    loadFromAirtable()
      .then(data=>{ rns=data; render(); document.getElementById("errorBar").style.display="none"; })
      .catch(()=>{ render(); document.getElementById("errorBar").style.display="block"; });

    // Refresh timestamps every 30s
    setInterval(()=>{
      document.querySelectorAll("[data-time]").forEach(el=>{
        el.textContent = fmtRel(el.getAttribute("data-time"));
      });
    }, 30000);

    // Re-fetch data every 5 minutes
    setInterval(()=>{
      loadFromAirtable()
        .then(data=>{ rns=data; render(); document.getElementById("errorBar").style.display="none"; })
        .catch(()=>  document.getElementById("errorBar").style.display="block");
    }, 300000);
  </script>
</body>
</html>
